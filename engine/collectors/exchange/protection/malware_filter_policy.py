"""Malware filter policy collector.

CIS Microsoft 365 Foundations Benchmark Controls:
    v6.0.0: 2.1.2, 2.1.3, 2.1.11

Connection Method: Exchange Online PowerShell (via Docker container)
Authentication: Client secret via MSAL -> access token passed to -AccessToken parameter
Required Cmdlets: Get-MalwareFilterPolicy
Required Permissions: Exchange.ManageAsApp + Exchange role assignment
"""

from typing import Any

from collectors.powershell_base import BasePowerShellCollector
from collectors.powershell_client import PowerShellClient


class MalwareFilterPolicyDataCollector(BasePowerShellCollector):
    """Collects malware filter policy for CIS compliance evaluation.

    This collector retrieves anti-malware settings including common
    attachment filter, admin notifications, and comprehensive filtering.
    """

    async def collect(self, client: PowerShellClient) -> dict[str, Any]:
        """Collect malware filter policy data.

        Returns:
            Dict containing:
            - malware_filter_policies: List of malware filter policies
            - default_policy: The default policy
            - enable_file_filter: Common attachment types filter status
        """
        policies = await client.run_cmdlet("ExchangeOnline", "Get-MalwareFilterPolicy")

        # Handle None, single policy, or list
        if policies is None:
            policies = []
        elif isinstance(policies, dict):
            policies = [policies]

        # Get default policy
        default_policy = next(
            (p for p in policies if p.get("IsDefault")),
            policies[0] if policies else None
        )

        return {
            "malware_filter_policies": policies,
            "total_policies": len(policies),
            "default_policy": default_policy,
            "enable_file_filter": default_policy.get("EnableFileFilter") if default_policy else None,
            "file_types": default_policy.get("FileTypes", []) if default_policy else [],
            "zap_enabled": default_policy.get("ZapEnabled") if default_policy else None,
        }
