# METADATA
# title: Ensure notifications for internal users sending malware is Enabled
# description: |
#   Exchange Online Protection is Microsoft's cloud-based filtering service
#   that protects organizations against spam, malware, and other email threats.
#   EOP is included in all Microsoft 365 organizations with Exchange Online mailboxes.
#  
# related_resources:
# - ref: https://www.cisecurity.org/benchmark/microsoft_365
#   description: CIS Microsoft 365 Foundations Benchmark
# custom:
#   control_id: CIS-2.1.3
#   framework: cis
#   benchmark: microsoft-365-foundations
#   version: v6.0.0
#   severity: medium
#   service: Exchange
#   requires_permissions:
#   - Exchange.Manage

package cis.microsoft_365_foundations.v6_0_0.control_2_1_3

default result = {"compliant": false, "message": "Evaluation failed"}

policies := object.get(input, "malware_filter_policies", [])

policy_list := policies
policy_list := [p] if {
    count(policies) == 0
    p := object.get(input, "default_policy", null)
    p != null
}

notifications_enabled if {
    count(policy_list) > 0
}

violating_policies[policy.Identity] if {
    some i
    policy := policy_list[i]
    not policy.EnableInternalSenderAdminNotifications
}

violating_policies[policy.Identity] if {
    some i
    policy := policy_list[i]
    policy.EnableInternalSenderAdminNotifications
    policy.InternalSenderAdminAddress == ""
}

notifications_configured if {
    count(violating_policies) == 0
}

compliant if {
    notifications_enabled
    notifications_configured
}

result = output if {
    message := generate_message
    affected_resources := {v | some i; v = violating_policies[i]}
    output := {
        "compliant": compliant,
        "message": message,
        "affected_resources": [v | v = affected_resources[_]],
        "details": {
            "notifications_enabled": notifications_enabled,
            "notifications_configured": notifications_configured,
            "policies_count": count(policy_list)
        }
    }
}

generate_message = msg if {
    compliant
    msg := "Internal sender admin notifications are enabled and configured correctly."
}

generate_message = msg if {
    not compliant
    msg := "Internal sender admin notifications are not properly configured."
}
