# METADATA
# title: Ensure notifications for internal users sending malware is Enabled
# description: |
#   Exchange Online Protection is Microsoft's cloud-based filtering service
#   that protects organizations against spam, malware, and other email threats.
#   EOP is included in all Microsoft 365 organizations with Exchange Online mailboxes.
#  
# related_resources:
# - ref: https://www.cisecurity.org/benchmark/microsoft_365
#   description: CIS Microsoft 365 Foundations Benchmark
# custom:
#   control_id: CIS-2.1.3
#   framework: cis
#   benchmark: microsoft-365-foundations
#   version: v6.0.0
#   severity: medium
#   service: Exchange
#   requires_permissions:
#   - Exchange.Manage

package cis.microsoft_365_foundations.v6_0_0.control_2_1_3

default result = {"compliant": false, "message": "Evaluation failed"}

policies := object.get(input, "malware_filter_policies", [])

policy_list := policies
policy_list := [p] if {
    count(policies) == 0
    p := object.get(input, "default_policy", null)
    p != null
}

has_policies := count(policy_list) > 0

notifications_enabled := true if { has_policies } else := false if { true }

policy_name(policy) := name if {
    name := object.get(policy, "Identity", null)
    name != null
} else := name if {
    name := object.get(policy, "Name", null)
    name != null
} else := "Unknown policy"

violating_policies[policy_name(policy)] if {
    some i
    policy := policy_list[i]
    object.get(policy, "EnableInternalSenderAdminNotifications", null) != true
}

violating_policies[policy_name(policy)] if {
    some i
    policy := policy_list[i]
    object.get(policy, "EnableInternalSenderAdminNotifications", null) == true
    object.get(policy, "InternalSenderAdminAddress", "") == ""
}

notifications_configured := true if {
    has_policies
    count(violating_policies) == 0
} else := false if { true }

compliant := true if {
    notifications_enabled
    notifications_configured
} else := false if { true }

result = output if {
    output := {
        "compliant": compliant,
        "message": generate_message(compliant, has_policies),
        "affected_resources": generate_affected_resources(compliant, has_policies, violating_policies),
        "details": {
            "notifications_enabled": notifications_enabled,
            "notifications_configured": notifications_configured,
            "policies_count": count(policy_list),
            "violations_count": count(violating_policies)
        }
    }
}

generate_message(true, _) := "Internal sender admin notifications are enabled and configured correctly."
generate_message(false, false) := "No malware filter policies were found to evaluate internal sender admin notifications."
generate_message(false, true) := "Internal sender admin notifications are not properly configured."

generate_affected_resources(true, _, _) := []
generate_affected_resources(false, false, _) := ["MalwareFilterPolicy"]
generate_affected_resources(false, true, violations) := [v | v := violations[_]]
