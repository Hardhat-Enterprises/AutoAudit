<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>AutoAudit – Evidence Scanner</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Brand fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=League+Spartan:wght@500;700&display=swap" rel="stylesheet">
  <style>
    :root{
      /* Brand palette (from your guide) */
      --royal:#072576;      /* primary royal blue */
      --teal:#64DFDF;       /* secondary teal */
      --ink:#000000;        /* black text */
      --bg:#f9fafb;         /* light surface */
      --muted:#6b7280;
      --border:#e5e7eb;
      --cta:#0d6efd;        /* action button */
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      font-family: "Helvetica Neue", Helvetica, Arial, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      color:var(--ink);
      background:#fff;
      max-width: 1060px;
      margin: 28px auto 80px;
      padding: 0 18px;
    }

    /* Brand header */
    .brand-wrap{ display:flex; align-items:flex-end; gap:12px; margin-bottom:6px; }
    .brand{
      margin:0;
      line-height:1;
      font-family: "League Spartan", system-ui, sans-serif;
      font-weight:700;
      font-size: clamp(28px, 7vw, 56px);
      letter-spacing:.5px;
      display:flex; align-items:baseline; gap:12px; flex-wrap:wrap;
    }
    .brand .royal{ color:var(--royal); }
    .brand .teal{ color:var(--teal); }
    .brand small{
      display:block;
      font-size: clamp(12px, 2.2vw, 16px);
      font-weight:500;
      color:var(--muted);
    }

    .sub{ color:var(--muted); margin:6px 0 18px; font-size:15px; }

    .card{
      border:1px solid var(--border);
      border-radius:16px;
      padding:18px;
      background:#fff;
      box-shadow: 0 1px 0 rgba(0,0,0,.03);
      margin-top:14px;
    }
    label{ display:block; margin:10px 0 6px; font-weight:600; color:#111; }
    select, input[type=text], input[type=file]{
      width:100%;
      padding:12px 12px;
      border:1px solid var(--border);
      border-radius:10px;
      font-size:15px;
      background:#fff;
    }
    select:focus, input:focus{ outline:2px solid var(--teal); outline-offset:1px; }

    .row{ display:grid; grid-template-columns: 1fr 1fr; gap:14px; }
    .help{ color:var(--muted); font-size:13px; margin-top:6px; }
    .hidden{ display:none; }

    .actions{ margin-top:16px; display:flex; align-items:center; gap:10px; }
    button{
      padding:11px 18px;
      border:0; border-radius:10px; cursor:pointer;
      background:var(--cta); color:#fff; font-weight:700; font-size:15px;
      transition: transform .04s ease;
    }
    button:hover{ transform: translateY(-1px); }
    button[disabled]{ opacity:.6; cursor:not-allowed; transform:none; }

    .error{ color:#b00020; font-weight:600; }

    table{ width:100%; border-collapse:collapse; margin-top:12px; }
    th, td{ border:1px solid var(--border); padding:10px; font-size:14px; vertical-align:top; }
    th{ background:var(--bg); text-align:left; font-weight:700; }
    .ok{ color:#047857; font-weight:700; }
    .bad{ color:#b00020; font-weight:700; }
    .tag{
      display:inline-block; padding:2px 10px;
      border:1px solid var(--border); border-radius:999px;
      font-size:12px; color:var(--muted)
    }

    /* responsive */
    @media (max-width: 760px){
      .row{ grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="brand-wrap">
    <h1 class="brand" aria-label="AUTO AUDIT">
      <span class="royal">AU<span class="teal">TO</span>
      <div></div>
      <span class="teal">AU<span class="royal">DIT</span>
      <small>Evidence Scanner</small>
    </h1>
  </div>
  <p class="sub">Pick a strategy, then upload a file. Images, PDF, DOCX, TXT, logs, registry exports are supported.</p>

  <div class="card">
    <div class="row">
      <div>
        <label for="strategy">Strategy</label>
        <select id="strategy"></select>
        <div id="strategyDesc" class="help"></div>
      </div>
      <div>
        <label for="user">User ID (optional)</label>
        <input id="user" type="text" placeholder="e.g. bharadwaj" />
      </div>
    </div>

    <div style="margin-top:14px;">
      <label for="file">Evidence file</label>
      <input id="file" type="file" disabled
             accept=".pdf,.png,.jpg,.jpeg,.tif,.tiff,.bmp,.webp,.txt,.docx,.csv,.log,.reg,.ini,.json,.xml,.htm,.html" />
      <div class="help">Enabled after you choose a strategy.</div>
    </div>

    <div class="actions">
      <button id="scanBtn" disabled>Scan Evidence</button>
      <span id="busy" class="help hidden">Scanning…</span>
      <span id="err" class="error"></span>
    </div>
  </div>

  <div id="results" class="card hidden">
    <h3 style="margin-top:0;">Results</h3>
    <div id="meta" class="help"></div>
    <div id="noFindings" class="help hidden">No readable text found or no findings.</div>
    <table id="rowsTable" class="hidden">
      <thead>
        <tr>
          <th>Test ID</th>
          <th>Sub-Strategy</th>
          <th>Level</th>
          <th>Status</th>
          <th>Priority</th>
          <th>Recommendation</th>
          <th>Evidence Extract</th>
          <th>Report</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

<script>
const API_BASE = location.origin;

const els = {
  strategy: document.getElementById('strategy'),
  strategyDesc: document.getElementById('strategyDesc'),
  user: document.getElementById('user'),
  file: document.getElementById('file'),
  scanBtn: document.getElementById('scanBtn'),
  busy: document.getElementById('busy'),
  err: document.getElementById('err'),
  results: document.getElementById('results'),
  meta: document.getElementById('meta'),
  noFindings: document.getElementById('noFindings'),
  rowsTable: document.getElementById('rowsTable'),
  tbody: document.querySelector('#rowsTable tbody'),
};

async function loadStrategies() {
  els.strategy.disabled = true;
  els.strategy.innerHTML = `<option value="" selected>Loading strategies…</option>`;
  try {
    const res = await fetch(`${API_BASE}/strategies`);
    const list = await res.json(); // [{name, description}]
    els.strategy.innerHTML = `<option value="" disabled selected>— select a strategy —</option>`;
    list.forEach(s => {
      const opt = document.createElement('option');
      opt.value = s.name;
      opt.textContent = s.name;
      opt.dataset.desc = s.description || '';
      els.strategy.appendChild(opt);
    });
  } catch (e) {
    els.strategy.innerHTML = `<option value="" selected>Failed to load strategies</option>`;
  } finally {
    els.strategy.disabled = false;
  }
}

function onStrategyChange() {
  const opt = els.strategy.options[els.strategy.selectedIndex];
  const desc = opt?.dataset?.desc || '';
  els.strategyDesc.textContent = desc;
  const hasChoice = !!els.strategy.value;
  els.file.disabled = !hasChoice;
  els.scanBtn.disabled = !hasChoice;
  els.err.textContent = '';
}

async function scan() {
  els.err.textContent = '';
  const strategy = els.strategy.value;
  const user = els.user.value || 'user';
  const file = els.file.files[0];

  if (!strategy) { els.err.textContent = 'Select a strategy.'; return; }
  if (!file) { els.err.textContent = 'Choose an evidence file.'; return; }

  const fd = new FormData();
  fd.append('strategy_name', strategy);
  fd.append('user_id', user);
  fd.append('evidence', file);

  els.scanBtn.disabled = true;
  els.busy.classList.remove('hidden');

  try {
    const res = await fetch(`${API_BASE}/scan`, { method: 'POST', body: fd });
    const raw = await res.text();
    let data = {};
    try {
      data = JSON.parse(raw);
    } catch {
      throw new Error(raw?.slice(0, 200) || 'Scan failed');
    }
    if (!res.ok || data.ok === false) {
      throw new Error(data?.detail || 'Scan failed');
    }
    renderResults(strategy, file.name, data);
  } catch (e) {
    els.err.textContent = (e?.message || 'Scan failed');
  } finally {
    els.scanBtn.disabled = false;
    els.busy.classList.add('hidden');
  }
}

function renderResults(strategy, filename, data) {
  els.results.classList.remove('hidden');
  els.meta.innerHTML = `
    <div><span class="tag">Strategy</span> ${strategy}</div>
    <div><span class="tag">File</span> ${filename}</div>
  `;

  const findings = Array.isArray(data?.findings) ? data.findings : [];
  const reports = Array.isArray(data?.reports) ? data.reports : [];
  els.tbody.innerHTML = '';

  if (!findings.length) {
    els.noFindings.classList.remove('hidden');
    els.rowsTable.classList.add('hidden');
    return;
  }
  els.noFindings.classList.add('hidden');
  els.rowsTable.classList.remove('hidden');

  findings.forEach((r, i) => {
    const tr = document.createElement('tr');
    const status = (r.pass_fail || '').toUpperCase();
    const statusClass = status === 'PASS' ? 'ok' : status === 'FAIL' ? 'bad' : '';
    const reportFile = reports[i] ? `${API_BASE}/reports/${encodeURIComponent(reports[i])}` : '';

    tr.innerHTML = `
      <td>${r.test_id || ''}</td>
      <td>${r.sub_strategy || ''}</td>
      <td>${r.detected_level || ''}</td>
      <td class="${statusClass}">${r.pass_fail || ''}</td>
      <td>${r.priority || ''}</td>
      <td>${r.recommendation || ''}</td>
      <td>${Array.isArray(r.evidence) ? r.evidence.join('<br>') : ''}</td>
      <td>${reportFile ? `<a href="${reportFile}" target="_blank" rel="noopener">PDF</a>` : ''}</td>
    `;
    els.tbody.appendChild(tr);
  });
}

els.strategy.addEventListener('change', onStrategyChange);
els.scanBtn.addEventListener('click', scan);
loadStrategies();
</script>
</body>
</html>
